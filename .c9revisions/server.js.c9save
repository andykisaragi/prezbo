{"ts":1365587087055,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var app = require('http').createServer(handler)\r\n, io = require('socket.io').listen(app)\r\n, fs = require('fs')\r\n, fu = require(\"./fu\")\r\n\r\n\r\napp.listen(process.env.PORT || 8001);\r\n\r\nvar clients = [ ];\r\nvar votes = [ ];\r\nvar options = Array('Yes','No');\r\n\r\nfor (var i=0; i < options.length; i++) {\r\n    votes.push({\r\n      name: options[i],\r\n      numVotes: 0\r\n    });\r\n}\r\n\r\nfunction extname(path) {\r\n    var index = path.lastIndexOf(\".\");\r\n    return index < 0 ? \"\" : path.substring(index);\r\n}\r\n\r\nfunction handler (req, res) {\r\n    \r\n    if (req.url != \"/\"){\r\n\r\n        var filename = req.url.replace(\"/\",\"\");\r\n\r\n        var content_type = fu.mime.lookupExtension(extname(filename));\r\n\r\n        fs.readFile(filename, function(err, data) {\r\n            if (err) {\r\n                    \r\n                console.log(\"Error loading \" + filename);\r\n            }\r\n            else {\r\n                var body = String(data);\r\n                body = body.replace(\"##PORT##\",process.env.PORT);\r\n                body = body.replace(\"##IP##\",process.env.IP);\r\n                var headers = {\r\n                    \"Content-Type\": content_type,\r\n                    \"Content-Length\": body.length\r\n                };\r\n                //if (!DEBUG) headers[\"Cache-Control\"] = \"public\";\r\n\r\n                res.writeHead(200, headers);\r\n                res.end(req.method === \"HEAD\" ? \"\" : body);\r\n            }\r\n        });\r\n    }else{    \r\n        fs.readFile('index.html',\r\n        function (err, data) {\r\n            if (err) {\r\n                res.writeHead(500);\r\n                return res.end('Error loading index.html');\r\n            }\r\n            \r\n            res.writeHead(200, {'Content-Type': 'text/html', \"Content-Length\": data.length});\r\n            res.end(data);\r\n        });\r\n    }\r\n}\r\n\r\nio.sockets.on('connection', function (socket) {\r\n    var index = clients.push(socket) - 1;\r\n    console.log (\"index \" + index);\r\n    // echo the message\r\n    socket.on('message', function (data) {\r\n        try {\r\n            var json = JSON.parse(data);\r\n        } catch (e) {\r\n            console.log('This doesn\\'t look like a valid JSON: ', data);\r\n            return;\r\n        }\r\n        if (json.type=='vote'){\r\n            votes[json.data].numVotes ++;\r\n            data = JSON.stringify({ type:'votes', data: votes })\r\n        }        \r\n        for (var i=0; i < clients.length; i++) {\r\n\r\n\r\n   \r\n            \r\n            clients[i].send(data);\r\n        }\r\n    });\r\n});"]],"start1":0,"start2":0,"length1":0,"length2":2470}]],"length":2470}
{"contributors":[],"silentsave":false,"ts":1365587760982,"patch":[[{"diffs":[[0," {\r\n"],[-1,"\r\n\r\n   \r\n"],[0,"    "]],"start1":2384,"start2":2384,"length1":17,"length2":8}]],"length":2461,"saved":false}
