<html>
<head>
<title>Cloud9, NodeJS & Heroku: websockets for all</title>

<script src="/socket.io/socket.io.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script>

<script>


onerror = function (msg) {
    log(msg);
};
function log(msg) {
    document.getElementById('log').appendChild(document.createTextNode(new Date() + ' ' + msg + '\n'));
}
function status(msg) {
    log(msg);
    document.getElementById('status').textContent = msg;
}
function clearLog() {
    var e = document.getElementById('log');
    while (e.hasChildNodes()) {
        e.removeChild(e.firstChild);
    }
    e.appendChild(document.createTextNode('Log: \n'));
}
</script>

</head>

<body onload="init()">
<p>
<label style='width:200px;float:left'>Status: <span id="status">Idle</span></label>
</p>
<p>SessionId: <span id="sessionId">-</span></p>
<p>Transport: <span id="transport">-</span></p>

<p>
<label>Message: <input id="text" type="text" size="80" value=""/></label>
<input type=button value="Echo" onclick="send()">
</p>

<p>
<!--<input type=button value="Spam 100 packets" onclick="send100()" />
<input type=button value="Clear log" onclick="clearLog()" />-->
<input type=button value="Yes" onclick="vote(0)" />
<input type=button value="No" onclick="vote(1)" />
</p>

<div>Yes: <span id="voteYes">0</span></div>
<div>No: <span id="voteNo">0</span></div>

<canvas id='canvas' width='350px' height='350px' style='border:1px solid #000;'></canvas>

<pre id="log">Log:</pre>

<script>
var socket = null;

var can = document.getElementById("canvas");
var ctx = can.getContext("2d");
var colours = new Array('#FF0000','0000FF','#00FF00','FF00FF','#FFFF00','00FFFF');
    

function init(){

    connect();    
}

function connect() {
    log('Connecting to local server...');
    if (socket == null) {
        socket = io.connect(null,{'auto connect': false});
        socket.on('connect', function () {
             status('Connected');
        });
        
        socket.on('message', function (data) {
            
            try {
                var json = JSON.parse(data);
            } catch (e) {
                console.log('This doesn\'t look like a valid JSON: ', data);
                return;
            }
            
            if (json.type=='message'){
                //log(json.type);
                log(json.data);
            }
            
            if (json.type=='votes'){
                updateVotes(json.data);            
            }
            
        });
    }
    socket.socket.connect();
}

function send() {
    if (socket && socket.socket.connected) {
        socket.send(JSON.stringify({ type:'message', data:document.getElementById('text').value}));
        log('>' + document.getElementById('text').value);
    } else {
        log('Not connected.');
    }
}

function updateVotes(data){
    
    ctx.fillStyle = "#eee";
    ctx.fillRect(0,0,350,350);
    
    var votes = data;
    
    var barWidth = 350 / votes.length;
    
    var totalVotes = 0;
    for (var i=0; i < votes.length; i++) {
        totalVotes += votes[i].numVotes;
    }
    
    for (var i=0; i < votes.length; i++) {
    
        var pct = votes[i].numVotes / totalVotes;
        var barHeight = 350 * pct;
        document.getElementById('vote' + votes[i].name).innerHTML = votes[i].numVotes + ' (' + (pct * 100) + '%)';
    
        ctx.fillStyle = colours[i];
        ctx.fillRect(i*barWidth,(350 - barHeight),barWidth,barHeight);
    
    }
    


}

function vote(option) {
    if (socket && socket.socket.connected) {
        
        socket.send(JSON.stringify({ type:'vote', data: option }));
    } else {
        log('Not connected.');
    }
}

function update() {
    if (socket && socket.socket && socket.socket.transport) {
        document.getElementById('sessionId').textContent = socket.socket.transport.sessid;
        document.getElementById('transport').textContent = socket.socket.transport.name;
    } else {
        document.getElementById('sessionId').textContent = '-';
        document.getElementById('transport').textContent = '-';
    }
}

setInterval(update, 10);

</script>


</body>
</html>